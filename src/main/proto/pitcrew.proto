syntax = "proto3";

import "google/protobuf/empty.proto";
import "google/protobuf/wrappers.proto";
import "race-flag-status.proto";

option java_package = "com.normtronix.meringue";

// Admin Service for managing current races, connecting and
// disconnecting the race meta data for them.
service PitcrewService {

  rpc ping(google.protobuf.Empty) returns (google.protobuf.Empty);

  rpc auth(PitAuthRequest) returns (PitAuthResponse);

  rpc getCarStatus(google.protobuf.Empty) returns (PitCarStatusResponse);

  rpc sendDriverMessage(PitDriverMessageRequest) returns (google.protobuf.BoolValue);

  rpc setTargetLapTime(PitSetTargetLapTimeRequest) returns (google.protobuf.BoolValue);

  rpc resetFastLapTime(PitResetFastLapTimeRequest) returns (google.protobuf.BoolValue);

  rpc setDriverName(PitSetDriverNameRequest) returns (google.protobuf.BoolValue);

  rpc streamCarDataV2(PitCarDataRequest) returns (stream ToPitCrewMessage);

}

message PitAuthRequest {
  string username = 1;
  string teamCode = 2;
}

message PitAuthResponse {
  string bearerToken = 1;
}

message PitDriverMessageRequest {
  string trackCode = 1;
  string carNumber = 2;
  string message = 3;
}

message PitResetFastLapTimeRequest {
  string trackCode = 1;
  string carNumber = 2;
}

message PitSetTargetLapTimeRequest {
  string trackCode = 1;
  string carNumber = 2;
  int32 targetTimeSeconds = 3;
}

message PitCarStatus {
  string carNumber = 1;
  string trackCode = 2;
  bool online = 3;
  string ipAddress = 4;
}

message PitCarStatusResponse {
  repeated PitCarStatus statusList = 1;
}

message PitSetDriverNameRequest {
  string trackCode = 1;
  string carNumber = 2;
  string driverName = 3;
}

message PitCarDataRequest {
  string trackCode = 1;
  string carNumber = 2;
}

message EnteringPits {
   int32 seq_num = 1;
   int32 timestamp = 2;
   string sender = 3;
}

message LeavingPits {
   int32 seq_num = 1;
   int32 timestamp = 2;
   string sender = 3;
}

message RaceStatus {
   int32 seq_num = 1;
   int32 timestamp = 2;
   string sender = 3;
   RaceFlagStatus flag_status = 4;
}

message SectorComplete {
   int32 seq_num = 1;
   int32 timestamp = 2;
   string sender = 3;
   float sector_time = 6;
   string sector_name = 7;   //  e.g. S1, S2, S3 or could be fancier "the esses"
   int32 sector_num = 8;  // e.g. 1, 2, 3
   float predicted_lap_time = 9; // in seconds and bits of seconds
   float predicted_delta_to_target = 10;   // e.g. +1.2 / -0.3
   float predicted_delta_to_best = 11;   // e.g. +1.2 / -0.3
   int32 lap_count = 12; // what lap the car is on, or this sector belongs to
   float best_sector_time = 13; // the best sector time ... can be zero
}


message PitCarData {
  string carNumber = 1;
  int64 timestamp = 2;
  RaceFlagStatus flagStatus = 3;
  int32 lapCount = 4;
  int32 position = 5;
  int32 positionInClass = 6;
  float lastLapTime = 7;
  string gap = 8;
  int32 coolantTemp = 9;
  int32 fuelRemainingPercent = 10;
  string driverMessage = 11;
  string carAhead = 12;
  string carBehind = 13;
  int32 fastestLap = 14;
  float fastestLapTime = 15;
  // extra sensors ... could be temp/pressure
  map<string, int32> extraSensors = 16;
}


message ToPitCrewMessage {
   oneof to_pit_crew {
      EnteringPits pitting = 2;
      LeavingPits entering = 3;
      RaceStatus race_status = 4;
      PitCarData car_data = 5;
      SectorComplete sector_details = 6;
   }
}

